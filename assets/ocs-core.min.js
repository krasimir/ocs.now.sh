!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).Octomments=n()}(this,function(){"use strict";function c(t){return function(t){if(Array.isArray(t))return t}(t)||n(t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(t){return function(t){if(Array.isArray(t)){for(var n=0,e=new Array(t.length);n<t.length;n++)e[n]=t[n];return e}}(t)||n(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function n(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function u(){return!0===function(){var t="test";try{return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function s(t,n){n=n||window.location.href,t=t.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]".concat(t,"(=([^&#]*)|&|#|$)")).exec(n);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function f(n){return["code","error","error_description","error_uri","t"].forEach(function(t){n=n.replace(new RegExp("[?&]".concat(t,"=[^&]+")),"")}),n}function h(t){return{id:t.id,url:t.html_url,author:{login:t.user.login,avatarUrl:t.user.avatar_url,url:t.user.html_url},body:t.body_html,createdAt:t.created_at,updatedAt:t.updated_at}}var l="ERROR",m="USER_LOADING",p="USER_NONE",d="USER_LOADED",o="COMMENTS_LOADING",g="COMMENTS_LOADED",v="COMMENT_SAVING",w="COMMENT_SAVED",E="OCTOMMENTS_USER",y=[l,o,g,v,m,p,d,w];function b(i,t){var c=i.notify,n=i.options,a=i.error,u=n.endpoints,s=n.number,e=n.github,f=!!u,l=new Error("Error getting comments for issue #".concat(s,".")),r=new Error("Issue #".concat(s," doesn't exists."));function m(t){console.error(t),a(l,2)}function d(e){return function(t,n){if(n)a(l,2);else if(t.ok)e(t);else{if(404===t.status)return a(r,1);e(t)}}}c(o),function r(t){var o=0<arguments.length&&void 0!==t?t:1,n="https://api.github.com/repos/".concat(e.owner,"/").concat(e.repo,"/issues/").concat(s,"/comments?page=").concat(o);fetch(n,{headers:i.getHeaders()}).then(d(function(t){if(!t.ok)return 401===t.status?(i.logout(!1),c(p),void r(o)):403===t.status?f?void fetch("".concat(u.issue,"?number=").concat(s)).then(d(function(t){t.ok?t.json().then(function(t){var n=t.issue.comments;i.data={comments:i.data.comments.concat(n),pagination:null},c(g,n,null)}).catch(function(t){console.error(t),a(new Error("Error parsing the API response"),3)}):a(l,2)})).catch(m):a(new Error("Rate limit exceeded."),4):a(l,2);var n=t.headers.get("Link"),e=null;n&&(e=function(t){var n=t.split(","),e={};for(var r in n){var o=n[r],i={};i.name=o.match(/rel=\"([^\"]*)/)[1],i.url=o.match(/<([^>]*)/)[1],i.page=parseInt(o.match(/page=(\d+).*$/)[1],10),e[i.name]=i}return e}(n)),t.json().then(function(t){var n=t.map(h);i.data={comments:i.data.comments.concat(n),pagination:e},c(g,n,e)}).catch(m)}))}(t)}function S(e,t){var r=e.notify,o=e.error,n=e.options,i=n.number,c=n.github,a=new Error("Adding a new comment failed.");r(v);var u,s="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(t){console.error(t),o(a,10)}fetch(s,{method:"POST",headers:e.getHeaders(),body:JSON.stringify({body:t})}).then((u=function(t){r(w,[h(t)])},function(t,n){return n?o(a,8):t.ok?void t.json().then(function(t){t?u(t):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===t.status?(e.logout(!1),r(p),o(new Error("Not authorized. Log in again."),9)):403===t.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function e(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"});var i={},e={user:null,data:{comments:[],pagination:null},options:o,LS:u(),error:function(t,n){e.notify(l,t,n)},notify:function(t){for(var n=arguments.length,e=new Array(1<n?n-1:0),r=1;r<n;r++)e[r-1]=arguments[r];o.debug&&console.log(t,e),i[t]&&i[t].forEach(function(t){return t.apply(void 0,e)})}};if(e.initUser=function(){return function(e){var r=e.notify,t=e.options,o=e.error,n=t.gotoComments;function i(){return history.replaceState({},document.title,"".concat(f(location.href)).concat(n?"#comments":""))}n=void 0===n||n;var c=e.generateNewCommentURL(),a=e.LS.getItem(E);if(a)try{e.user=JSON.parse(a),r(d,e.user)}catch(t){console.error(t),o(new Error("Corrupted data in local storage."),5)}else if(s("t")){var u=s("t");e.user={token:u},r(m),fetch("https://api.github.com/user",{headers:e.getHeaders()}).then(function(t,n){n||!t.ok?(n&&console.error(n),i(),o(new Error("Problem getting user's info."),6)):t.json().then(function(t){e.user={token:e.user.token,login:t.login,avatarUrl:t.avatar_url,url:t.html_url,name:t.name},i(),e.LS.setItem(E,JSON.stringify(e.user)),r(d,e.user)}).catch(function(t){console.error(t),o(new Error("Problem parsing access token response."),7)})}).catch(function(t){console.error(t),o(new Error("Problem getting access token."),6)})}else r(p,c)}(e)},e.initComments=function(){return b(e)},e.logout=function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];e.user=null,e.LS.removeItem(E),t&&location.reload()},e.add=function(t){if(!e.user)throw new Error("No user logged in.");S(e,t)},e.off=function(t){return delete i[t],this},e.on=function(t,n){return i[t]||(i[t]=[]),i[t].push(n),this},e.init=function(){e.initUser(),e.initComments()},e.page=function(t){b(e,t)},e.generateNewCommentURL=function(){return t=o.endpoints.token,n=f(window.location.href),"".concat(t,"?redirect=").concat(encodeURI(n));var t,n},e.getHeaders=function(){var t={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return e.user&&e.user.token&&(t.Authorization="token ".concat(e.user.token)),t},y.forEach(function(t){return e[t]=t}),o.renderer){var t=c(o.renderer),n=t[0],r=t.slice(1);n.apply(void 0,[e].concat(a(r)))}return e}return y.forEach(function(t){return e[t]=t}),e});