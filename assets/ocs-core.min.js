!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n=n||self).Octomments=e()}(this,function(){"use strict";function c(n){return function(n){if(Array.isArray(n))return n}(n)||e(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(n){return function(n){if(Array.isArray(n)){for(var e=0,t=new Array(n.length);e<n.length;e++)t[e]=n[e];return t}}(n)||e(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function u(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function s(n,e){e=e||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(e);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}function f(e){return["code","error","error_description","error_uri","t"].forEach(function(n){e=e.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),e}var l="ERROR",m="USER_LOADING",d="USER_NONE",h="USER_LOADED",p="COMMENTS_LOADING",g="COMMENTS_LOADED",w="COMMENT_SAVING",E="COMMENT_SAVED",v="OCTOMMENTS_USER",y=[l,p,g,w,m,d,h,E];function b(t){var r,o=t.notify,n=t.options,i=t.error,e=n.endpoints,c=n.number,a=n.github,u=new Error("Error getting comments for issue #".concat(c,".")),s=new Error("Issue #".concat(c," doesn't exists."));function f(n){console.error(n),i(u,2)}o(p),fetch("".concat(e.issue,"?owner=").concat(a.owner,"&repo=").concat(a.repo,"&number=").concat(c)).then((r=function(n){n.ok?n.json().then(function(n){var e=n.issue.comments;t.data={comments:t.data.comments.concat(e),pagination:null},o(g,e,null)}).catch(function(n){console.error(n),i(new Error("Error parsing the API response"),3)}):i(u,2)},function(n,e){if(e)i(u,2);else if(n.ok)r(n);else{if(404===n.status)return i(s,1);r(n)}})).catch(f)}function S(t,n){var r=t.notify,o=t.error,e=t.options,i=e.number,c=e.github,a=new Error("Adding a new comment failed.");r(w);var u,s="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(n){console.error(n),o(a,10)}fetch(s,{method:"POST",headers:t.getHeaders(),body:JSON.stringify({body:n})}).then((u=function(n){var e;r(E,[{id:(e=n).id,url:e.html_url,author:{login:e.user.login,avatarUrl:e.user.avatar_url,url:e.user.html_url},body:e.body_html,createdAt:e.created_at,updatedAt:e.updated_at}])},function(n,e){return e?o(a,8):n.ok?void n.json().then(function(n){n?u(n):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===n.status?(t.logout(!1),r(d),o(new Error("Not authorized. Log in again."),9)):403===n.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function t(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),o.debug&&console.log("Octomments started with: ",JSON.stringify(o,null,2));var i={},t={user:null,data:{comments:[],pagination:null},options:o,LS:u(),error:function(n,e){t.notify(l,n,e)},notify:function(n){for(var e=arguments.length,t=new Array(1<e?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];o.debug&&console.log(n,t),i[n]&&i[n].forEach(function(n){return n.apply(void 0,t)})}};if(t.initUser=function(){return function(t){var r=t.notify,n=t.options,o=t.error,e=n.gotoComments;function i(){return history.replaceState({},document.title,"".concat(f(location.href)).concat(e?"#comments":""))}e=void 0===e||e;var c=t.generateNewCommentURL(),a=t.LS.getItem(v);if(a)try{t.user=JSON.parse(a),r(h,t.user)}catch(n){console.error(n),o(new Error("Corrupted data in local storage."),5)}else if(s("t")){var u=s("t");t.user={token:u},r(m),fetch("https://api.github.com/user",{headers:t.getHeaders()}).then(function(n,e){e||!n.ok?(e&&console.error(e),i(),o(new Error("Problem getting user's info."),6)):n.json().then(function(n){t.user={token:t.user.token,login:n.login,avatarUrl:n.avatar_url,url:n.html_url,name:n.name},i(),t.LS.setItem(v,JSON.stringify(t.user)),r(h,t.user)}).catch(function(n){console.error(n),o(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),o(new Error("Problem getting access token."),6)})}else r(d,c)}(t)},t.initComments=function(){return b(t)},t.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];t.user=null,t.LS.removeItem(v),n&&location.reload()},t.add=function(n){if(!t.user)throw new Error("No user logged in.");S(t,n)},t.off=function(n){return delete i[n],this},t.on=function(n,e){return i[n]||(i[n]=[]),i[n].push(e),this},t.init=function(){t.initUser(),t.initComments()},t.page=function(n){b(t)},t.generateNewCommentURL=function(){return n=o.endpoints.token,e=f(window.location.href),"".concat(n,"?redirect=").concat(encodeURI(e));var n,e},t.getHeaders=function(){var n={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return t.user&&t.user.token&&(n.Authorization="token ".concat(t.user.token)),n},y.forEach(function(n){return t[n]=n}),o.renderer){var n=c(o.renderer),e=n[0],r=n.slice(1);e.apply(void 0,[t].concat(a(r)))}return t}return y.forEach(function(n){return t[n]=n}),t});