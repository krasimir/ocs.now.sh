!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).Octomments=t()}(this,function(){"use strict";function o(n){return function(n){if(Array.isArray(n))return n}(n)||t(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(n){return function(n){if(Array.isArray(n)){for(var t=0,e=new Array(n.length);t<n.length;t++)e[t]=n[t];return e}}(n)||t(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function a(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function f(n,t){t=t||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(t);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function l(t){return["code","error","error_description","error_uri"].forEach(function(n){t=t.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),t}var u="ERROR",m="USER_LOADING",d="USER_NONE",h="USER_LOADED",e="COMMENTS_LOADING",p="COMMENTS_LOADED",g="COMMENT_SAVING",w="COMMENT_SAVED",E="OCTOMMENTS_USER",v=[u,e,p,g,m,d,h,w];function b(r,n){var c=r.notify,t=r.options,i=r.error,a=t.endpoints,u=t.number,o=t.github,s=!!a,f=new Error("Error getting comments for issue #".concat(u,".")),l=new Error("Issue #".concat(u," doesn't exists."));c(e),function(n){var t=0<arguments.length&&void 0!==n?n:1,e="https://api.github.com/repos/".concat(o.owner,"/").concat(o.repo,"/issues/").concat(u,"/comments?page=").concat(t);fetch(e,{headers:{Accept:"application/vnd.github.v3.html+json"}}).then(function(n,t){if(t)i(f,2);else{if(!n.ok)return 404===n.status?i(l,1):403===n.status?s?void fetch("".concat(a.issue,"?number=").concat(u)).then(function(n,t){t?i(f,2):n.ok?n.json().then(function(n){var t=n.issue.comments;r.data={comments:r.data.comments.concat(t),pagination:null},c(p,t,null)}).catch(function(n){console.error(n),i(new Error("Error parsing the API response"),3)}):404===n.status?i(l,1):i(f,2)}).catch(function(n){console.error(n),i(f,2)}):i(new Error("Rate limit exceeded."),4):i(f,2);var e=n.headers.get("Link"),o=null;e&&(o=function(n){var t=n.split(","),e={};for(var o in t){var r=t[o],c={};c.name=r.match(/rel=\"([^\"]*)/)[1],c.url=r.match(/<([^>]*)/)[1],c.page=parseInt(r.match(/page=(\d+).*$/)[1],10),e[c.name]=c}return e}(e)),n.json().then(function(n){var t=n.map(function(n){return{id:n.id,url:n.html_url,author:{login:n.user.login,avatarUrl:n.user.avatar_url,url:n.user.html_url},body:n.body_html,createdAt:n.created_at,updatedAt:n.updated_at}});r.data={comments:r.data.comments.concat(t),pagination:o},c(p,t,o)}).catch(function(n){console.error(n),i(f,2)})}})}(n)}function r(r){if(!r)throw new Error("Octomments options required.");if(!r.github||!r.github.owner||!r.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!r.number)throw new Error("`options.number` is missing.");var c={},s={user:null,data:{comments:[],pagination:null},options:r,LS:a(),error:function(n,t){s.notify(u,n,t)},notify:function(n){for(var t=arguments.length,e=new Array(1<t?t-1:0),o=1;o<t;o++)e[o-1]=arguments[o];r.debug&&console.log(n,e),c[n]&&c[n].forEach(function(n){return n.apply(void 0,e)})}};if(s.initUser=function(){return function(e){var o=e.notify,n=e.options,r=e.error,t=n.endpoints,c=n.gotoComments;function i(){return history.replaceState({},document.title,"".concat(l(location.href)).concat(c?"#comments":""))}c=void 0===c||c,o(m);var a=e.generateNewCommentURL(),u=e.LS.getItem(E);if(u)try{e.user=JSON.parse(u),o(h,e.user)}catch(n){console.error(n),r(new Error("Corrupted data in local storage."),5)}else t&&f("code")?fetch("".concat(t.token,"?code=").concat(f("code"))).then(function(n,t){t||!n.ok?(t&&console.error(t),i(),r(new Error("Problem getting access token."),6)):n.json().then(function(n){i(),e.LS.setItem(E,JSON.stringify(n)),e.user=n,o(h,n)}).catch(function(n){console.error(n),r(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),r(new Error("Problem getting access token."),6)}):o(d,a)}(s)},s.initComments=function(){return b(s)},s.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];s.user=null,s.LS.removeItem(E),n&&location.reload()},s.add=function(n){if(!s.user)throw new Error("No user logged in.");var e,t,o,r,c,i,a,u;t=n,o=(e=s).notify,r=e.error,c=e.options,i=c.endpoints,a=c.number,u=new Error("Adding a new comment failed."),o(g),fetch("".concat(i.issue),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:!0,body:t,token:e.user.token,number:a})}).then(function(n,t){return t?r(u,8):n.ok?void n.json().then(function(n){n.issue.comments?o(w,n.issue.comments):r(new Error("Parsing new-comment response failed."),10)}).catch(function(n){console.error(n),r(u,10)}):401===n.status?(e.logout(!1),o(d),r(new Error("Not authorized. Log in again."),9)):r(u,8)}).catch(function(n){console.error(n),r(u,8)})},s.off=function(n){return delete c[n],this},s.on=function(n,t){return c[n]||(c[n]=[]),c[n].push(t),this},s.init=function(){s.initUser(),s.initComments()},s.page=function(n){b(s,n)},s.generateNewCommentURL=function(){return r.endpoints?(e=r.endpoints.token,o=l(window.location.href),"".concat(e,"?redirect_url=").concat(encodeURI(o))):r.github?(n=r.number,t=r.github,"https://github.com/".concat(t.owner,"/").concat(t.repo,"/issues/").concat(n,"#new_comment_field")):null;var n,t,e,o},v.forEach(function(n){return s[n]=n}),r.renderer){var n=o(r.renderer),t=n[0],e=n.slice(1);t.apply(void 0,[s].concat(i(e)))}return s}return v.forEach(function(n){return r[n]=n}),r});!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).OctommentsRenderer=t()}(this,function(){"use strict";var d="O_",r=function(n){var t=0<arguments.length&&void 0!==n?n:24;return'<svg width="'.concat(t,'" height="').concat(t,'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>')};function l(n){return document.querySelector(n)}function u(n,t,o,e){var a=0<arguments.length&&void 0!==n?n:"div",c=1<arguments.length&&void 0!==t?t:"",i=2<arguments.length&&void 0!==o?o:null,r=3<arguments.length&&void 0!==e?e:null,s=document.createElement(a);return s.setAttribute("class",d+c),i&&i.appendChild(s),r&&(s.innerHTML=r),s}function v(n){for(;n.firstChild;)n.removeChild(n.firstChild)}function g(n,t){var o=l(n);o?o.addEventListener("click",t):console.warn("Octomments: ".concat(n," element doesn't exists in the DOM"))}function h(e,c){var o,t={},a=[];function i(n){v(e),u("div","error",e,"<div>".concat(n,"</div>"))}return t.loading=function(){0===a.length?(v(e),u("div","summary",e,'\n      <div>Loading comments ...</div>\n        <div>\n          <a href="https://octomments.now.sh/" target="_blank">\n            '.concat(r(14),"\n          </a>\n        </div>"))):o.innerHTML='\n        <div></div>\n        <div class="'.concat(d,'more-comments-loading"><small>loading ...</small></div>\n      ')},t.noComments=function(){v(e)},t.newComment=function(n){t.data(n)},t.data=function(n,t){a=a.concat(n),v(e),u("div","summary",e,'\n        <div id="'.concat(d,'num-of-comments">').concat(a.length," comment").concat(1!==a.length?"s":"",'</div>\n        <div>\n          <a href="https://octomments.now.sh/" target="_blank">\n            ').concat(r(14),"\n          </a>\n        </div>\n      ")),a.forEach(function(n){var t,o;u("div","comment",e,'\n          <div class="'.concat(d,'comment_left">\n            <img src="').concat(n.author.avatarUrl,'" />\n          </div>\n          <div class="').concat(d,'comment_right">\n            <div class="').concat(d,'comment_heading">\n              <strong>').concat(n.author.login,"</strong>\n              <small> ~ ").concat((t=n.updatedAt,o=new Date(t),"".concat(o.getDate(),".").concat(o.getMonth()+1,".").concat(o.getFullYear())),'</small>\n              <a href="').concat(n.url,'" target="_blank" class="').concat(d,'right">').concat(r(16),'</a>\n            </div>\n            <div class="').concat(d,'comment_body">\n              ').concat(n.body,"\n            </div>\n          </div>\n        "))}),t&&t.next&&(o=u("div","comment ".concat(d,"more-comments"),e,'\n          <div></div>\n          <div>\n            <a href="javascript:void(0);" id="'.concat(d,'more-comments-link">\n              <small>... load more comments</small>\n            </a>\n          </div>\n        ')),g("#".concat(d,"more-comments-link"),function(){c.page(t.next.page)}))},c.on(c.ERROR,function(n,t){var o=c.options,e=o.number,a=o.github;1===t?i("Issue <strong>#".concat(e,"</strong> doesn't exists at <a href=\"https://github.com/").concat(a.owner,"/").concat(a.repo,'/issues" target="_blank">').concat(a.repo," repo</a>.")):2!==t&&3!==t&&4!==t||(i('There is a problem fetching the comments. Wait a bit and click <a href="javascript:void(0);" id="'.concat(d,'comments_try_again">here</a> to try again.')),g("#".concat(d,"comments_try_again"),c.initComments))}),t}return function(n,t){var o=l(t);if(!o)throw new Error("Octomments: invalid container selector.");var a,e,c,i=u("div","root",o),r=h(u("div","comments",i),n),s=(a=u("div","new-comment",i),e=n,c={},a.style.display="none",c.loading=function(){v(a),u("small","comment",a,'\n      <div></div>\n      <div class="'.concat(d,'loading-user"><small>Loading user ...</small></div>\n      '))},c.noUser=function(n){v(a),u("div","tar",a,'<a href="'.concat(n,'" class="').concat(d,'as-button">&#x271A; new comment</a>'))},c.form=function(){var n=e.user;if(!n)return c.loading();v(a),u("div","comment",a,'\n        <div class="'.concat(d,'comment_left" id="').concat(d,'new_comment">\n          <img src="').concat(n.avatarUrl,'" />\n        </div>\n        <div class="').concat(d,'comment_right">\n          <textarea id="').concat(d,'_textarea" placeholder="I think ..."></textarea>\n          <button id="').concat(d,'_submit_comment">Comment</button>\n          <a href="javascript:void(0);" id="').concat(d,'logout" class="').concat(d,"right ").concat(d,'logout"><small>Log out</small></a>\n        </div>\n    ')),g("#".concat(d,"_submit_comment"),function(){var n=l("#".concat(d,"_textarea")).value;""!==n&&e.add(n)}),g("#".concat(d,"logout"),function(){e.logout()})},e.on(e.ERROR,function(n,t){1===t?v(a):5===t?(e.logout(!1),c.noUser(e.generateNewCommentURL())):6===t||7===t||10===t?(m('There is a problem initializing your user. Wait a bit and click <a href="javascript:void(0);" id="'.concat(d,'user_try_again">here</a> to try again.')),g("#".concat(d,"user_try_again"),e.initUser)):8===t?m("There is a problem posting your comment. Please try again in a couple of minutes.",!1,l(".".concat(d,"comment_right"))).style.marginTop="1em":9===t&&(e.logout(!1),m('Not authorized. Click <a href="javascript:void(0);" id="'.concat(d,'user_login">here</a> to login again.')),g("#".concat(d,"user_login"),e.initUser))}),e.on(e.COMMENTS_LOADED,function(){a.style.display="block"}),c);function m(n,t,o){var e=2<arguments.length&&void 0!==o?o:a;return(!(1<arguments.length&&void 0!==t)||t)&&v(a),u("div","error_user",e,"<div>".concat(n,"</div>"))}n.on(n.COMMENTS_LOADING,r.loading).on(n.COMMENTS_LOADED,r.data).on(n.USER_LOADING,s.loading).on(n.USER_NONE,s.noUser).on(n.USER_LOADED,s.form).on(n.COMMENT_SAVING,function(){l("#".concat(d,"new_comment")).style.opacity=.4;var n=l("#".concat(d,"_submit_comment")),t=l("#".concat(d,"_textarea"));n.disabled=!0,t.disabled=!0,n.innerHTML="Posting your comment ..."}).on(n.COMMENT_SAVED,function(n){s.form(),r.newComment(n)})}});