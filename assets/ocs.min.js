!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n=n||self).Octomments=e()}(this,function(){"use strict";function c(n){return function(n){if(Array.isArray(n))return n}(n)||e(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(n){return function(n){if(Array.isArray(n)){for(var e=0,t=new Array(n.length);e<n.length;e++)t[e]=n[e];return t}}(n)||e(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function u(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function s(n,e){e=e||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var t=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(e);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}function f(e){return["code","error","error_description","error_uri","t"].forEach(function(n){e=e.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),e}var l="ERROR",m="USER_LOADING",d="USER_NONE",h="USER_LOADED",p="COMMENTS_LOADING",g="COMMENTS_LOADED",w="COMMENT_SAVING",E="COMMENT_SAVED",v="OCTOMMENTS_USER",y=[l,p,g,w,m,d,h,E];function b(t){var r,o=t.notify,n=t.options,i=t.error,e=n.endpoints,c=n.number,a=n.github,u=new Error("Error getting comments for issue #".concat(c,".")),s=new Error("Issue #".concat(c," doesn't exists."));function f(n){console.error(n),i(u,2)}o(p),fetch("".concat(e.issue,"?owner=").concat(a.owner,"&repo=").concat(a.repo,"&number=").concat(c)).then((r=function(n){n.ok?n.json().then(function(n){var e=n.issue.comments;t.data={comments:t.data.comments.concat(e),pagination:null},o(g,e,null)}).catch(function(n){console.error(n),i(new Error("Error parsing the API response"),3)}):i(u,2)},function(n,e){if(e)i(u,2);else if(n.ok)r(n);else{if(404===n.status)return i(s,1);r(n)}})).catch(f)}function S(t,n){var r=t.notify,o=t.error,e=t.options,i=e.number,c=e.github,a=new Error("Adding a new comment failed.");r(w);var u,s="https://api.github.com/repos/".concat(c.owner,"/").concat(c.repo,"/issues/").concat(i,"/comments");function f(n){console.error(n),o(a,10)}fetch(s,{method:"POST",headers:t.getHeaders(),body:JSON.stringify({body:n})}).then((u=function(n){var e;r(E,[{id:(e=n).id,url:e.html_url,author:{login:e.user.login,avatarUrl:e.user.avatar_url,url:e.user.html_url},body:e.body_html,createdAt:e.created_at,updatedAt:e.updated_at}])},function(n,e){return e?o(a,8):n.ok?void n.json().then(function(n){n?u(n):o(new Error("Parsing new-comment response failed."),10)}).catch(f):401===n.status?(t.logout(!1),r(d),o(new Error("Not authorized. Log in again."),9)):403===n.status?o(new Error("Rate limit exceeded."),4):o(a,8)})).catch(f)}function t(o){if(!o)throw new Error("Octomments options required.");if(!o.github||!o.github.owner||!o.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!o.number)throw new Error("`options.number` is missing.");o.endpoints||(o.endpoints={issue:"https://ocs.now.sh/octomments/issue",token:"https://ocs.now.sh/octomments/token"}),o.debug&&console.log("Octomments started with: ",JSON.stringify(o,null,2));var i={},t={user:null,data:{comments:[],pagination:null},options:o,LS:u(),error:function(n,e){t.notify(l,n,e)},notify:function(n){for(var e=arguments.length,t=new Array(1<e?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];o.debug&&console.log(n,t),i[n]&&i[n].forEach(function(n){return n.apply(void 0,t)})}};if(t.initUser=function(){return function(t){var r=t.notify,n=t.options,o=t.error,e=n.gotoComments;function i(){return history.replaceState({},document.title,"".concat(f(location.href)).concat(e?"#comments":""))}e=void 0===e||e;var c=t.generateNewCommentURL(),a=t.LS.getItem(v);if(a)try{t.user=JSON.parse(a),r(h,t.user)}catch(n){console.error(n),o(new Error("Corrupted data in local storage."),5)}else if(s("t")){var u=s("t");t.user={token:u},r(m),fetch("https://api.github.com/user",{headers:t.getHeaders()}).then(function(n,e){e||!n.ok?(e&&console.error(e),i(),o(new Error("Problem getting user's info."),6)):n.json().then(function(n){t.user={token:t.user.token,login:n.login,avatarUrl:n.avatar_url,url:n.html_url,name:n.name},i(),t.LS.setItem(v,JSON.stringify(t.user)),r(h,t.user)}).catch(function(n){console.error(n),o(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),o(new Error("Problem getting access token."),6)})}else r(d,c)}(t)},t.initComments=function(){return b(t)},t.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];t.user=null,t.LS.removeItem(v),n&&location.reload()},t.add=function(n){if(!t.user)throw new Error("No user logged in.");S(t,n)},t.off=function(n){return delete i[n],this},t.on=function(n,e){return i[n]||(i[n]=[]),i[n].push(e),this},t.init=function(){t.initUser(),t.initComments()},t.page=function(n){b(t)},t.generateNewCommentURL=function(){return n=o.endpoints.token,e=f(window.location.href),"".concat(n,"?redirect=").concat(encodeURI(e));var n,e},t.getHeaders=function(){var n={"Content-Type":"application/json",Accept:"application/vnd.github.v3.html+json"};return t.user&&t.user.token&&(n.Authorization="token ".concat(t.user.token)),n},y.forEach(function(n){return t[n]=n}),o.renderer){var n=c(o.renderer),e=n[0],r=n.slice(1);e.apply(void 0,[t].concat(a(r)))}return t}return y.forEach(function(n){return t[n]=n}),t});!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).OctommentsRenderer=t()}(this,function(){"use strict";var d="O_",r=function(n){var t=0<arguments.length&&void 0!==n?n:24;return'<svg width="'.concat(t,'" height="').concat(t,'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>')};function l(n){return document.querySelector(n)}function u(n,t,o,e){var a=0<arguments.length&&void 0!==n?n:"div",c=1<arguments.length&&void 0!==t?t:"",i=2<arguments.length&&void 0!==o?o:null,r=3<arguments.length&&void 0!==e?e:null,s=document.createElement(a);return s.setAttribute("class",d+c),i&&i.appendChild(s),r&&(s.innerHTML=r),s}function v(n){for(;n.firstChild;)n.removeChild(n.firstChild)}function g(n,t){var o=l(n);o?o.addEventListener("click",t):console.warn("Octomments: ".concat(n," element doesn't exists in the DOM"))}function h(e,c){var o,t={},a=[];function i(n){v(e),u("div","error",e,"<div>".concat(n,"</div>"))}return t.loading=function(){0===a.length?(v(e),u("div","summary",e,'\n      <div>Loading comments ...</div>\n        <div>\n          <a href="https://octomments.now.sh/" target="_blank">\n            '.concat(r(14),"\n          </a>\n        </div>"))):o.innerHTML='\n        <div></div>\n        <div class="'.concat(d,'more-comments-loading"><small>loading ...</small></div>\n      ')},t.noComments=function(){v(e)},t.newComment=function(n){t.data(n)},t.data=function(n,t){a=a.concat(n),v(e),u("div","summary",e,'\n        <div id="'.concat(d,'num-of-comments">').concat(a.length," comment").concat(1!==a.length?"s":"",'</div>\n        <div>\n          <a href="https://octomments.now.sh/" target="_blank">\n            ').concat(r(14),"\n          </a>\n        </div>\n      ")),a.forEach(function(n){var t,o;u("div","comment",e,'\n          <div class="'.concat(d,'comment_left">\n            <img src="').concat(n.author.avatarUrl,'" />\n          </div>\n          <div class="').concat(d,'comment_right">\n            <div class="').concat(d,'comment_heading">\n              <strong>').concat(n.author.login,"</strong>\n              <small> ~ ").concat((t=n.updatedAt,o=new Date(t),"".concat(o.getDate(),".").concat(o.getMonth()+1,".").concat(o.getFullYear())),'</small>\n              <a href="').concat(n.url,'" target="_blank" class="').concat(d,'right">').concat(r(16),'</a>\n            </div>\n            <div class="').concat(d,'comment_body">\n              ').concat(n.body,"\n            </div>\n          </div>\n        "))}),t&&t.next&&(o=u("div","comment ".concat(d,"more-comments"),e,'\n          <div></div>\n          <div>\n            <a href="javascript:void(0);" id="'.concat(d,'more-comments-link">\n              <small>... load more comments</small>\n            </a>\n          </div>\n        ')),g("#".concat(d,"more-comments-link"),function(){c.page(t.next.page)}))},c.on(c.ERROR,function(n,t){var o=c.options,e=o.number,a=o.github;1===t?i("Issue <strong>#".concat(e,"</strong> doesn't exists at <a href=\"https://github.com/").concat(a.owner,"/").concat(a.repo,'/issues" target="_blank">').concat(a.repo," repo</a>.")):2!==t&&3!==t&&4!==t||(i('There is a problem fetching the comments. Wait a bit and click <a href="javascript:void(0);" id="'.concat(d,'comments_try_again">here</a> to try again.')),g("#".concat(d,"comments_try_again"),c.initComments))}),t}return function(n,t){var o=l(t);if(!o)throw new Error("Octomments: invalid container selector.");var a,e,c,i=u("div","root",o),r=h(u("div","comments",i),n),s=(a=u("div","new-comment",i),e=n,c={},a.style.display="none",c.loading=function(){v(a),u("small","comment",a,'\n      <div></div>\n      <div class="'.concat(d,'loading-user"><small>Loading user ...</small></div>\n      '))},c.noUser=function(n){v(a),u("div","tar",a,'<a href="'.concat(n,'" class="').concat(d,'as-button">&#x271A; new comment</a>'))},c.form=function(){var n=e.user;if(!n)return c.loading();v(a),u("div","comment",a,'\n        <div class="'.concat(d,'comment_left" id="').concat(d,'new_comment">\n          <img src="').concat(n.avatarUrl,'" />\n        </div>\n        <div class="').concat(d,'comment_right">\n          <textarea id="').concat(d,'_textarea" placeholder="I think ..."></textarea>\n          <button id="').concat(d,'_submit_comment">Comment</button>\n          <a href="javascript:void(0);" id="').concat(d,'logout" class="').concat(d,"right ").concat(d,'logout"><small>Log out</small></a>\n        </div>\n    ')),g("#".concat(d,"_submit_comment"),function(){var n=l("#".concat(d,"_textarea")).value;""!==n&&e.add(n)}),g("#".concat(d,"logout"),function(){e.logout()})},e.on(e.ERROR,function(n,t){1===t?v(a):5===t?(e.logout(!1),c.noUser(e.generateNewCommentURL())):6===t||7===t||10===t?(m('There is a problem initializing your user. Wait a bit and click <a href="javascript:void(0);" id="'.concat(d,'user_try_again">here</a> to try again.')),g("#".concat(d,"user_try_again"),e.initUser)):8===t?m("There is a problem posting your comment. Please try again in a couple of minutes.",!1,l(".".concat(d,"comment_right"))).style.marginTop="1em":9===t&&(e.logout(!1),m('Not authorized. Click <a href="javascript:void(0);" id="'.concat(d,'user_login">here</a> to login again.')),g("#".concat(d,"user_login"),e.initUser))}),e.on(e.COMMENTS_LOADED,function(){a.style.display="block"}),c);function m(n,t,o){var e=2<arguments.length&&void 0!==o?o:a;return(!(1<arguments.length&&void 0!==t)||t)&&v(a),u("div","error_user",e,"<div>".concat(n,"</div>"))}n.on(n.COMMENTS_LOADING,r.loading).on(n.COMMENTS_LOADED,r.data).on(n.USER_LOADING,s.loading).on(n.USER_NONE,s.noUser).on(n.USER_LOADED,s.form).on(n.COMMENT_SAVING,function(){l("#".concat(d,"new_comment")).style.opacity=.4;var n=l("#".concat(d,"_submit_comment")),t=l("#".concat(d,"_textarea"));n.disabled=!0,t.disabled=!0,n.innerHTML="Posting your comment ..."}).on(n.COMMENT_SAVED,function(n){s.form(),r.newComment(n)})}});