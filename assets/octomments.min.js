!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).Octomments=t()}(this,function(){"use strict";function o(n){return function(n){if(Array.isArray(n))return n}(n)||t(n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(n){return function(n){if(Array.isArray(n)){for(var t=0,e=new Array(n.length);t<n.length;t++)e[t]=n[t];return e}}(n)||t(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function t(n){if(Symbol.iterator in Object(n)||"[object Arguments]"===Object.prototype.toString.call(n))return Array.from(n)}function a(){return!0===function(){var n="test";try{return localStorage.setItem(n,n),localStorage.removeItem(n),!0}catch(n){return!1}}()?localStorage:{setItem:function(){},getITem:function(){}}}function f(n,t){t=t||window.location.href,n=n.replace(/[\[\]]/g,"\\$&");var e=new RegExp("[?&]".concat(n,"(=([^&#]*)|&|#|$)")).exec(t);return e?e[2]?decodeURIComponent(e[2].replace(/\+/g," ")):"":null}function l(t){return["code","error","error_description","error_uri"].forEach(function(n){t=t.replace(new RegExp("[?&]".concat(n,"=[^&]+")),"")}),t}var u="ERROR",m="USER_LOADING",d="USER_NONE",h="USER_LOADED",e="COMMENTS_LOADING",p="COMMENTS_LOADED",g="COMMENT_SAVING",w="COMMENT_SAVED",E="OCTOMMENTS_USER",v=[u,e,p,g,m,d,h,w];function b(r,n){var c=r.notify,t=r.options,i=r.error,a=t.endpoints,u=t.number,o=t.github,s=!!a,f=new Error("Error getting comments for issue #".concat(u,".")),l=new Error("Issue #".concat(u," doesn't exists."));c(e),function(n){var t=0<arguments.length&&void 0!==n?n:1,e="https://api.github.com/repos/".concat(o.owner,"/").concat(o.repo,"/issues/").concat(u,"/comments?page=").concat(t);fetch(e,{headers:{Accept:"application/vnd.github.v3.html+json"}}).then(function(n,t){if(t)i(f,2);else{if(!n.ok)return 404===n.status?i(l,1):403===n.status?s?void fetch("".concat(a.issue,"?number=").concat(u)).then(function(n,t){t?i(f,2):n.ok?n.json().then(function(n){var t=n.issue.comments;r.data={comments:r.data.comments.concat(t),pagination:null},c(p,t,null)}).catch(function(n){console.error(n),i(new Error("Error parsing the API response"),3)}):404===n.status?i(l,1):i(f,2)}).catch(function(n){console.error(n),i(f,2)}):i(new Error("Rate limit exceeded."),4):i(f,2);var e=n.headers.get("Link"),o=null;e&&(o=function(n){var t=n.split(","),e={};for(var o in t){var r=t[o],c={};c.name=r.match(/rel=\"([^\"]*)/)[1],c.url=r.match(/<([^>]*)/)[1],c.page=parseInt(r.match(/page=(\d+).*$/)[1],10),e[c.name]=c}return e}(e)),n.json().then(function(n){var t=n.map(function(n){return{id:n.id,url:n.html_url,author:{login:n.user.login,avatarUrl:n.user.avatar_url,url:n.user.html_url},body:n.body_html,createdAt:n.created_at,updatedAt:n.updated_at}});r.data={comments:r.data.comments.concat(t),pagination:o},c(p,t,o)}).catch(function(n){console.error(n),i(f,2)})}})}(n)}function r(r){if(!r)throw new Error("Octomments options required.");if(!r.github||!r.github.owner||!r.github.repo)throw new Error("`options.github` is missing or incomplete.");if(!r.number)throw new Error("`options.number` is missing.");var c={},s={user:null,data:{comments:[],pagination:null},options:r,LS:a(),error:function(n,t){s.notify(u,n,t)},notify:function(n){for(var t=arguments.length,e=new Array(1<t?t-1:0),o=1;o<t;o++)e[o-1]=arguments[o];r.debug&&console.log(n,e),c[n]&&c[n].forEach(function(n){return n.apply(void 0,e)})}};if(s.initUser=function(){return function(e){var o=e.notify,n=e.options,r=e.error,t=n.endpoints,c=n.gotoComments;function i(){return history.replaceState({},document.title,"".concat(l(location.href)).concat(c?"#comments":""))}c=void 0===c||c,o(m);var a=e.generateNewCommentURL(),u=e.LS.getItem(E);if(u)try{e.user=JSON.parse(u),o(h,e.user)}catch(n){console.error(n),r(new Error("Corrupted data in local storage."),5)}else t&&f("code")?fetch("".concat(t.token,"?code=").concat(f("code"))).then(function(n,t){t||!n.ok?(t&&console.error(t),i(),r(new Error("Problem getting access token."),6)):n.json().then(function(n){i(),e.LS.setItem(E,JSON.stringify(n)),e.user=n,o(h,n)}).catch(function(n){console.error(n),r(new Error("Problem parsing access token response."),7)})}).catch(function(n){console.error(n),r(new Error("Problem getting access token."),6)}):o(d,a)}(s)},s.initComments=function(){return b(s)},s.logout=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];s.user=null,s.LS.removeItem(E),n&&location.reload()},s.add=function(n){if(!s.user)throw new Error("No user logged in.");var e,t,o,r,c,i,a,u;t=n,o=(e=s).notify,r=e.error,c=e.options,i=c.endpoints,a=c.number,u=new Error("Adding a new comment failed."),o(g),fetch("".concat(i.issue),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:!0,body:t,token:e.user.token,number:a})}).then(function(n,t){return t?r(u,8):n.ok?void n.json().then(function(n){n.issue.comments?o(w,n.issue.comments):r(new Error("Parsing new-comment response failed."),10)}).catch(function(n){console.error(n),r(u,10)}):401===n.status?(e.logout(!1),o(d),r(new Error("Not authorized. Log in again."),9)):r(u,8)}).catch(function(n){console.error(n),r(u,8)})},s.off=function(n){return delete c[n],this},s.on=function(n,t){return c[n]||(c[n]=[]),c[n].push(t),this},s.init=function(){s.initUser(),s.initComments()},s.page=function(n){b(s,n)},s.generateNewCommentURL=function(){return r.endpoints?(e=r.endpoints.token,o=l(window.location.href),"".concat(e,"?redirect_url=").concat(encodeURI(o))):r.github?(n=r.number,t=r.github,"https://github.com/".concat(t.owner,"/").concat(t.repo,"/issues/").concat(n,"#new_comment_field")):null;var n,t,e,o},v.forEach(function(n){return s[n]=n}),r.renderer){var n=o(r.renderer),t=n[0],e=n.slice(1);t.apply(void 0,[s].concat(i(e)))}return s}return v.forEach(function(n){return r[n]=n}),r});